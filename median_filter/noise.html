<head>
    <title></title>
</head>

<body>
    <div><h4>Загрузите ваше изображение</h4>
        <h5><input type="file"></h5>
    </div>
    <canvas id="image"></canvas>

    <script>
        var percent = prompt('Процент шума:', 10);

        var input = document.querySelector('input');
        var canvas = document.getElementById("image"); 
        cx = canvas.getContext('2d');
        var red = [];
        var green = [];
        var blue = [];

        var img = new Image();

        input.addEventListener("change", function(event) {
            var reader = new FileReader();
            reader.onload = function(event) {
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    cx.drawImage(img, 0, 0);
                    transformCanvas(canvas);
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(event.target.files[0]);
        });


        function getPixelColor(imageData, x, y) {
            var width = imageData.width;
            var base = 4 * (width * y + x);
            var r = imageData.data[base];
            var g = imageData.data[base+1];
            var b = imageData.data[base+2];
            var a = imageData.data[base+3];
            return [r, g, b, a];
        }

        function setPixelColor(imageData, x, y, rgba) {
            var width = imageData.width;
            var base = 4 * (width * y + x);
            imageData.data[base]   = rgba[0];
            imageData.data[base+1] = rgba[1];
            imageData.data[base+2] = rgba[2];
            imageData.data[base+3] = rgba[3];
        }

        function randint(a, b) {
            return Math.floor(a + Math.random() * (b - a));
        }

        function clamp(min, max, x) {
            return Math.max(min, Math.min(max, x));
        }

        function compareNumbers(a, b) {
            return a - b;
        }

        function noise(imageData, x, y) {
            var size = 5;
            var halfSize = (size - 1) / 2;
            var medianIndex = Math.floor(size * size / 2);
            for (var dy = 0; dy < size; dy++) {
                for (var dx = 0; dx < size; dx++) {
                    var sx = clamp(0, imageData.width  - 1, x + dx - halfSize);
                    var sy = clamp(0, imageData.height - 1, y + dy - halfSize);
                    var rgb = getPixelColor(imageData, sx, sy);
                    red  [dy * size + dx] = rgb[0];
                    green[dy * size + dx] = rgb[1];
                    blue [dy * size + dx] = rgb[2];
                }
            }

            var r = red[medianIndex];
            var g = green[medianIndex];
            var b = blue[medianIndex];

            if ((Math.random()*10)/(percent/10) <= 1) {
                r = 255;
                g = 255;
                b = 255;
            }
            return [r, g, b, 255];
        }

        function transformCanvas(canvas) {
            var cx = canvas.getContext('2d');
            var imageData = cx.getImageData(0, 0, canvas.width, canvas.height);
            var newImageData = cx.createImageData(imageData);
            for (var x = 0; x < imageData.width; x++) {
                for (var y = 0; y < imageData.height; y++) {
                    setPixelColor(newImageData, x, y, noise(imageData, x, y));
                }
            }
            cx.putImageData(newImageData, 0, 0);
        }

    </script>
</body>